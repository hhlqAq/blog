# 用户发起请求阶段（网络前置）
## DNS解析
- DNS 解析时间的合理范围与优化阈值
优秀：≤ 50ms（本地 DNS 缓存命中或 CDN 节点就近解析）。
正常：50ms ~ 100ms（常规 DNS 服务器响应）。
需优化：100ms ~ 300ms（解析延迟较高，可能影响首屏加载）。
严重问题：＞300ms（可能是 DNS 服务器故障、域名配置错误或网络路由问题）。
- 优化方向：
减少域名数量（合并第三方资源到主域名）。
启用 DNS 预解析（`<link rel="dns-prefetch" href="//cdn.example.com">`）。
合理设置 DNS 缓存 TTL（建议 1 小时以上）。
## TCP 连接（三次握手）
- 性能指标：
TCP 连接耗时（目标：≤100ms，取决于网络环境）。
- 问题场景：
首次请求无连接复用，需完整三次握手。
网络不稳定导致握手超时重连。
- 优化方向：
启用 HTTP/2（多路复用，减少连接建立次数）。
复用长连接（设置 Connection: keep-alive）。
部署 CDN 节点，减少用户到服务器的物理距离。
## HTTPS 握手（TLS 协商）
- 性能指标：
HTTPS 握手耗时（目标：≤100ms，取决于服务器配置）。
- 问题场景：
首次请求 HTTPS 需完整握手过程。
证书链过长（中间证书过多）导致验证耗时增加。
- 优化方向：
升级到 TLS 1.3（握手步骤减少，耗时降低 50%+）。
启用 TLS 会话复用（Session ID/Ticket）。
缩短证书链（移除不必要的中间证书）。

# 资源加载阶段
## 首字节时间（TTFB，Time to First Byte）
- 性能指标：
从请求发出到接收第一个字节的时间（目标：≤50ms，反映服务器响应速度）。
- 问题场景：
服务器响应时间过长，导致用户等待时间增加。
- 分析
DevTools「Network」面板查看「Waiting (TTFB)」耗时。
- 优化方向：
优化服务器端响应时间（如缓存静态资源、压缩响应数据等）。
## 资源下载效率
- 性能指标：
关键资源（HTML、核心 CSS/JS）下载耗时。
总资源体积（目标：首屏资源 ≤ 1MB）。
- 问题场景
  - 资源未压缩（JS/CSS 未 minify，图片未压缩）。
  - 未使用 HTTP 压缩（Gzip/Brotli）。
  - 关键资源加载顺序不合理（如 CSS 放在 body 底部导致阻塞渲染）。
- 分析方法
  - DevTools 「Network」 面板按「Size」排序，查看大体积资源。
  - 用 [「Coverage」 面板分析](./Coverage覆盖率.md) JS/CSS 未使用比例（死代码）
- 优化方向：
   - 压缩资源（Terser 压缩 JS，css-minimizer 压缩 CSS，WebP/AVIF 格式图片）。
   - 启用 Brotli 压缩（比 Gzip 压缩率高 15-20%）要考虑浏览器兼容性（如 IE 不支持 Brotli）。
   - 关键资源优先加载（CSS 放 head，JS 用 async/defer 延迟非关键脚本）。
## 资源阻塞问题
- 性能指标：
渲染阻塞资源（CSS、同步 JS）数量。
解析阻塞资源（同步 JS）耗时。
- 问题场景：
同步 JS 执行时间过长，阻塞 HTML 解析和 CSSOM 构建。
非关键 CSS 未拆分，导致首屏 CSS 体积过大。
- 分析方法：
  - DevTools「Performance」面板录制加载过程，查看「Main」线程中「Parse HTML/CSS」「Evaluate Script」的阻塞时段。
  - 用「Lighthouse」检测「Render-blocking resources」。
- 优化方向：
   - 拆分 CSS（首屏 CSS 内联到 HTML，非首屏 CSS 异步加载）。
   - 同步 JS 改为异步（async/defer），或延迟到 DOMContentLoaded 后执行。
# 页面渲染阶段
## DOM 构建与 CSSOM 构建
- 性能指标：
  - DOM 构建耗时（HTML 解析为 DOM 树）。
  - CSSOM 构建耗时（CSS 解析为样式树）。
- 问题场景：
  - HTML 结构过于复杂（嵌套层级深、节点过多）。
  - CSS 选择器复杂（如 div:nth-child(2) > .class ~ span），导致匹配耗时。
- 分析方法：
  - DevTools「Performance」面板查看「Parse HTML」「Recalculate Style」耗时。
  - 用「Elements」面板检查 DOM 层级（建议嵌套 ≤ 10 层）。
- 优化方向：
   - 简化 HTML 结构（避免过深嵌套、过多节点）。
   - 优化 CSS 选择器（避免复杂选择器，如避免使用 :nth-child、:not 等伪类）。
## 布局（Layout/Reflow）与重绘（Repaint）
- 性能指标：
  - 布局次数及耗时（每帧布局耗时 ≤ 1ms）。
  - 重绘区域大小（避免全屏重绘）。
- 问题场景：
  - 频繁修改布局属性（width、height、top 等），触发多次布局。
  - 滚动时动态修改元素样式（如列表懒加载时频繁计算位置）。
- 分析方法：
  - DevTools「More Tools」→「Rendering」勾选「Paint flashing」，直观查看重绘区域。
  - 用「Elements」面板检查元素的布局变化（如元素尺寸/位置是否改变）。
- 优化方向：
   - 批量操作 DOM（如使用文档片段 DocumentFragment 批量添加节点）。
   - 避免频繁操作样式（如使用 class 切换样式，而不是直接操作 style 属性）。
   - 优化复杂动画（如使用 requestAnimationFrame 控制动画帧，避免在布局阶段触发重排）。
   - 批量修改样式（先修改 display: none，更新样式后再显示，减少布局次数）。
   - 使用 will-change: transform 或 transform: translateZ(0) 触发 GPU 加速，避免布局和重绘（仅对位移、缩放等有效）。
   - 避免滚动时执行布局操作（如 offsetHeight、getBoundingClientRect）。
## 合成（Composite）
- 性能指标：合成层数量及合并耗时（目标：合成层 ≤ 10 层，避免层爆炸）。
- 问题场景：
   - 过多元素触发 GPU 加速（如大量 transform、opacity 动画），导致层爆炸。
   - 合成层之间存在重叠，触发层合并耗时。
- 分析方法 
  - DevTools「Layers」面板查看合成层数量、大小及原因。
- 优化方向：
  - 限制合成层数量（避免非必要元素使用 will-change）。
  - 避免合成层重叠（通过布局调整分离重叠元素）。
## 交互响应阶段
- 首屏响应时间（目标：≤1s，反映用户感知速度）。
  - 业务自定义哪部分为首屏，以及哪些资源是首屏必须加载的。
- 分析方法
  - DevTools「Performance」面板查看「First Contentful Paint」（FCP）耗时。
  - 业务自定义收集首屏资源加载耗时。
- 优化方向：
  - 优化首屏渲染时间（如减少关键资源体积、延迟加载非首屏资源等）。
## 首次输入延迟（FID）与输入延迟（INP）
- 性能指标：
  - 首次输入延迟（FID）：用户首次与页面交互（如点击、输入）到浏览器响应的时间（目标：≤100ms）。
  - 输入延迟（INP）：用户后续交互到浏览器响应的时间（目标：≤200ms）。
- 问题场景：
  - 页面响应缓慢（如 JS 复杂计算、布局重排），导致输入延迟。
  - 输入事件（如 input、click）绑定了耗时逻辑。
- 分析方法：
  - DevTools「Performance」面板录制交互过程，查看「Main」线程中超过 50ms 的长任务。
- 优化方向：
  - 拆分长任务（将复杂计算拆分为微任务，用 requestIdleCallback 处理非紧急逻辑）。
  - 输入事件处理逻辑异步化（避免同步阻塞）。
  - 使用 Web Worker 处理耗时计算（脱离主线程）。
## 累计布局偏移（CLS）
- 性能指标：页面元素意外偏移的累积分数（目标：≤0.1，核心 Web Vitals 指标）。
- 问题场景：
  - 图片 / 视频未设置固定尺寸，加载后撑开容器。
  - 动态插入内容（如广告、弹窗）导致周边元素偏移。
- 分析方法：
  - DevTools「Performance」面板查看「Layout Shift」事件。
- 优化方向：
  - 为媒体元素（图片、视频）设置 width/height 属性或占位容器。
  - 动态内容插入前预留空间（如骨架屏）。
# 后端与基建影响
## 服务端渲染（SSR）/ 静态生成（SSG）性能
- 问题场景：
  - SSR 服务渲染耗时过长（如 Node.js 内存泄漏、渲染逻辑复杂）。
  - 静态页面 CDN 缓存失效，频繁回源。
- 分析方法：
   - 监控 SSR 服务的响应时间（如用 Prometheus 采集接口耗时）。
   - 检查 CDN 回源率（通过 CDN 控制台查看），低于 %5 较为理想 。
- 优化方向：
  - 缓存 SSR 渲染结果（如 Redis 缓存热门页面）。
  - 静态页面启用 CDN 长期缓存（配合内容哈希）。
## API 接口性能
- 问题场景：
  - 前端异步请求（如接口数据）耗时过长，阻塞页面渲染。
  - 接口返回数据冗余，增加传输和解析成本。
- 分析方法：
  - DevTools「Network」面板查看 XHR/fetch 请求的「Response Time」。
  - 用「Chrome DevTools > Performance」标记接口请求的开始和结束时间。
- 优化方向：
  - 接口数据缓存（HTTP 缓存、Service Worker 缓存）。
  - 接口数据压缩（如 GraphQL 按需请求字段，减少冗余）。
# 全链路分析工具链
- 实时监测：Chrome DevTools（Network/Performance/Layers）、Lighthouse、Web Vitals 扩展。
- 线上监控：Sentry（错误 + 性能）、Datadog（全链路追踪）、百度统计（用户体验指标）。
- 性能预算：webpack-bundle-analyzer（资源体积）、speed-measure-webpack-plugin（构建性能）。