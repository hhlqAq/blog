# 问题场景
总资源大小一样，分一次请求 还是多次

如：依赖 vue、vue-router、axios 等第三方库


在弱网下，多个https请求资源的性能较差，一个是并发限制，另一个是丢包导致的队头阻塞。
在好网下，多个https请求资源的性能较好

在构建时，提前打包弱网备用资源 ，单独打包为 weak.js

# 第一步：工程化配置（提前打包弱网备用资源）
## 1. 修改 vue.config.js：拆分 “弱网专用 chunk”
```js
// vue.config.js
const { defineConfig } = require('@vue/cli-service');

module.exports = defineConfig({
  configureWebpack: {
    // 1. 拆分弱网备用 chunk：将 vue、vue-router、axios 单独打包
    optimization: {
      splitChunks: {
        chunks: 'all',
        cacheGroups: {
          // 弱网专用 chunk：仅包含三个核心依赖
          vendorWeaknet: {
            test: /[\\/]node_modules[\\/](vue|vue-router|axios)[\\/]/,
            name: 'vendor-weaknet', // 输出文件名：vendor-weaknet.js
            priority: 20, // 优先级高于其他 chunk，确保优先拆分
            reuseExistingChunk: true,
            enforce: true // 强制拆分，即使体积小也单独打包
          }
        }
      }
    },
    // 2. 动态控制 externals：好网络时不打包（用 CDN），弱网时打包（不用 externals）
    // 这里先不写死 externals，后续通过环境变量或代码动态切换
    externals: process.env.VUE_APP_WEAKNET === 'true' 
      ? {} // 弱网：不配置 externals，Webpack 打包三者到 vendor-weaknet.js
      : { // 好网络：配置 externals，不打包三者（用 CDN）
          vue: 'Vue',
          'vue-router': 'VueRouter',
          axios: 'axios'
        }
  },
  // 3. 生成资源路径映射：方便前端动态加载弱网 chunk
  chainWebpack: (config) => {
    // 生成 chunk 路径映射文件（weaknet-chunk-map.json）
    config.plugin('weaknet-chunk-map').use(require('webpack-plugin-chunk-map'), [
      {
        filename: 'weaknet-chunk-map.json',
        chunks: ['vendor-weaknet'] // 只映射弱网备用 chunk
      }
    ]);
  }
});
```
## 生成 “弱网环境变量” 脚本
```js
// scripts/set-weaknet-env.js
const fs = require('fs');
const path = require('path');

// 写入环境变量文件：标记是否为弱网打包模式
const envContent = `VUE_APP_WEAKNET=${process.argv[2] === 'weaknet' ? 'true' : 'false'}`;
fs.writeFileSync(path.resolve(__dirname, '../.env.weaknet'), envContent);

console.log(`已设置环境变量：${envContent}`);
```
## 配置打包命令（package.json）
```js
{
  "scripts": {
    "build": "vue-cli-service build", // 正常打包（好网络用，不打包三者）
    "build:weaknet": "node scripts/set-weaknet-env.js weaknet && vue-cli-service build --mode weaknet" // 弱网打包（打包三者到 vendor-weaknet.js）
  }
}
```
- 执行 npm run build：生成好网络资源（index.html 不包含三者，依赖 CDN）；
- 执行 npm run build:weaknet：生成弱网资源（vendor-weaknet.js 包含三者，index.html 无需 CDN）。
# 第二步：前端代码实现（动态检测 + 加载）
## 1. 修改 public/index.html：添加网络检测和动态加载逻辑
```html
<!-- public/index.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>Vue 动态资源加载</title>
  <!-- 1. 网络环境检测脚本（优先执行） -->
  <script>
    // 检测网络类型：2G/3G 视为弱网，4G/5G/Wi-Fi 视为好网络
    function detectNetwork() {
      const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
      if (!connection) return 'unknown'; // 无法检测时，默认按好网络处理
      
      const networkType = connection.type; // 网络类型：wifi/4g/3g/2g/ethernet 等
      const effectiveType = connection.effectiveType; // 实际网络质量：4g/3g/2g
      
      // 弱网判断条件：2G/3G 或 网络质量差
      return ['2g', '3g', 'slow-2g'].includes(effectiveType) || ['2g', '3g'].includes(networkType)
        ? 'weaknet'
        : 'goodnet';
    }

    // 2. 动态加载资源（好网络 CDN，弱网本地 chunk）
    async function loadResources() {
      const network = detectNetwork();
      const chunkMap = await fetch('/weaknet-chunk-map.json').then(res => res.json()); // 加载弱网 chunk 路径映射
      
      if (network === 'goodnet') {
        // 好网络：加载 CDN 资源（顺序：vue → vue-router → axios，确保依赖正确）
        const cdnUrls = [
          'https://cdn.bootcdn.net/ajax/libs/vue/3.3.4/vue.global.prod.js',
          'https://cdn.bootcdn.net/ajax/libs/vue-router/4.2.5/vue-router.global.prod.js',
          'https://cdn.bootcdn.net/ajax/libs/axios/1.6.2/axios.min.js'
        ];
        
        // 逐个加载 CDN 资源（确保依赖顺序）
        for (const url of cdnUrls) {
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = url;
            script.onload = resolve;
            // CDN 加载失败降级：切换为弱网资源
            script.onerror = () => {
              console.warn(`CDN 加载失败，降级为弱网资源：${url}`);
              loadWeaknetResources(chunkMap);
              reject();
            };
            document.head.appendChild(script);
          });
        }
      } else {
        // 弱网：加载本地 vendor-weaknet.js
        loadWeaknetResources(chunkMap);
      }

      // 3. 资源加载完成后，启动 Vue 应用（加载 main.js）
      function startApp() {
        const mainScript = document.createElement('script');
        mainScript.src = '/js/app.js'; // 业务代码入口（Vue 初始化代码在这里）
        document.body.appendChild(mainScript);
      }

      // 加载弱网资源
      function loadWeaknetResources(chunkMap) {
        const weaknetScript = document.createElement('script');
        weaknetScript.src = chunkMap.vendorWeaknet; // 从映射文件获取弱网 chunk 路径
        weaknetScript.onload = startApp;
        document.head.appendChild(weaknetScript);
      }

      // 好网络资源加载完成后启动应用
      if (network === 'goodnet') {
        startApp();
      }
    }

    // 启动资源加载流程
    loadResources();
  </script>
</head>
<body>
  <div id="app"></div>
  <!-- 注意：这里不写默认的 main.js 引入，改为动态加载 -->
</body>
</html>
```