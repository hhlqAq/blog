```js
const path = require('path');
const { DefinePlugin } = require('webpack');
const HtmlWebpackPlugin = require('html-webpack-plugin');
const MiniCssExtractPlugin = require('mini-css-extract-plugin');
const CssMinimizerPlugin = require('css-minimizer-webpack-plugin');
const TerserPlugin = require('terser-webpack-plugin');
const { VueLoaderPlugin } = require('vue-loader');
const AutoImport = require('unplugin-auto-import/webpack');
const Components = require('unplugin-vue-components/webpack');
const { ElementPlusResolver } = require('unplugin-vue-components/resolvers');
const ESLintPlugin = require('eslint-webpack-plugin');
const StylelintPlugin = require('stylelint-webpack-plugin');
const CopyPlugin = require('copy-webpack-plugin');
const { WebpackManifestPlugin } = require('webpack-manifest-plugin');
const ForkTsCheckerWebpackPlugin = require('fork-ts-checker-webpack-plugin');
const { PurgeCSSPlugin } = require('purgecss-webpack-plugin');
const glob = require('glob-all');
const dotenv = require('dotenv');
const fs = require('fs');

// ===================== 环境变量加载 =====================
// 加载 .env 文件（Vue CLI 默认支持 .env.development/.env.production 等）
const envFiles = [
  `.env.${process.env.NODE_ENV}.local`,
  `.env.${process.env.NODE_ENV}`,
  process.env.NODE_ENV !== 'production' && `.env.local`,
  '.env'
].filter(Boolean);

envFiles.forEach(file => {
  if (fs.existsSync(file)) {
    dotenv.config({ path: file });
  }
});

// ===================== 基础配置 =====================
const baseConfig = {
  // 入口文件（Vue CLI 默认 src/main.js 或 src/main.ts）
  entry: path.resolve(__dirname, 'src/main.js'),

  // 输出配置
  output: {
    // 输出目录（Vue CLI 默认 dist，可通过 outputDir 配置修改）
    path: path.resolve(__dirname, 'dist'),
    // 入口文件输出名：开发环境用[name].js，生产环境加contenthash做缓存
    filename: process.env.NODE_ENV === 'production'
      ? 'js/[name].[contenthash:8].js'
      : 'js/[name].js',
    // 异步Chunk输出名（路由懒加载等异步代码）
    chunkFilename: process.env.NODE_ENV === 'production'
      ? 'js/[name].[contenthash:8].chunk.js'
      : 'js/[name].chunk.js',
    // 静态资源输出路径（图片、字体等）
    assetModuleFilename: 'assets/[name].[hash:8][ext][query]',
    // 清空输出目录（Vue CLI 默认开启，对应 clean: true）
    clean: true,
    // 公共路径：生产环境可能配置CDN地址，开发环境用 '/'
    publicPath: process.env.NODE_ENV === 'production'
      ? process.env.VUE_APP_PUBLIC_PATH || '/'
      : '/'
  },

  // 解析配置
  resolve: {
    // 扩展名：import时可省略的后缀（Vue CLI 默认支持的常见后缀）
    extensions: ['.mjs', '.js', '.jsx', '.vue', '.ts', '.tsx', '.json'],
    // 别名配置（Vue CLI 常用别名，简化导入路径）
    alias: {
      '@': path.resolve(__dirname, 'src'), // 对应 src 目录
      'vue$': process.env.VUE_VERSION === '3' 
        ? 'vue/dist/vue.esm-bundler.js' // Vue3 运行时+编译器版本
        : 'vue/dist/vue.esm.js', // Vue2 运行时+编译器版本
      '@components': path.resolve(__dirname, 'src/components'),
      '@views': path.resolve(__dirname, 'src/views'),
      '@utils': path.resolve(__dirname, 'src/utils'),
      '@assets': path.resolve(__dirname, 'src/assets')
    },
    // 模块解析目录（优先node_modules，可添加自定义目录）
    modules: ['node_modules', path.resolve(__dirname, 'src/modules')],
    // 解析器配置（Vue CLI 默认禁用 symlinks，避免软链接问题）
    symlinks: false
  },

  // 模块规则（核心：处理各种文件类型的加载器）
  module: {
    rules: [
      // ===================== Vue 单文件组件处理 =====================
      {
        test: /\.vue$/, // 匹配 .vue 文件
        loader: 'vue-loader', // Vue CLI 核心加载器，解析 .vue 结构（template/style/script）
        options: {
          compilerOptions: {
            // 自定义Vue模板编译器选项（如是否保留空格）
            preserveWhitespace: false
          },
          // 缓存加载结果，提升构建速度（开发环境默认开启）
          cacheDirectory: path.resolve(__dirname, 'node_modules/.cache/vue-loader'),
          cacheIdentifier: `vue-loader-${process.env.NODE_ENV}`
        }
      },

      // ===================== JavaScript/TypeScript 处理 =====================
      {
        test: /\.(js|jsx|mjs)$/, // 匹配JS相关文件
        exclude: /node_modules/, // 排除node_modules（第三方库一般已编译）
        use: [
          {
            loader: 'babel-loader', // Vue CLI 默认使用babel处理JS，兼容低版本浏览器
            options: {
              // 缓存编译结果（大幅提升二次构建速度）
              cacheDirectory: path.resolve(__dirname, 'node_modules/.cache/babel-loader'),
              // 预设配置（Vue CLI 内置 @vue/babel-preset-app）
              presets: [
                [
                  '@vue/babel-preset-app',
                  {
                    useBuiltIns: 'usage', // 按需引入polyfill（根据代码使用情况）
                    corejs: 3, // 使用core-js@3版本（现代浏览器兼容核心）
                    targets: {
                      // 浏览器兼容目标（Vue CLI 默认配置，支持95%以上主流浏览器）
                      browsers: ['> 1%', 'last 2 versions', 'not dead', 'not IE 11']
                    }
                  }
                ]
              ],
              // 插件：支持可选链操作符、空值合并等新语法
              plugins: [
                '@babel/plugin-proposal-optional-chaining',
                '@babel/plugin-proposal-nullish-coalescing-operator'
              ]
            }
          }
        ]
      },
      {
        test: /\.(ts|tsx)$/, // 匹配TS相关文件
        exclude: /node_modules/,
        use: [
          'babel-loader', // 配合@babel/preset-typescript使用
          {
            loader: 'ts-loader', // 解析TypeScript
            options: {
              appendTsSuffixTo: [/\.vue$/], // 给.vue文件添加.ts后缀，支持TSX语法
              transpileOnly: true, // 只转译不做类型检查（类型检查交给fork-ts-checker-plugin）
              compilerOptions: {
                target: 'ESNext',
                module: 'ESNext',
                sourceMap: process.env.NODE_ENV !== 'production'
              }
            }
          }
        ]
      },

      // ===================== 样式文件处理（CSS/SCSS/SASS/LESS/STYLUS） =====================
      {
        test: /\.(css|scss|sass|less|styl|stylus)$/,
        use: [
          // 生产环境提取CSS为单独文件，开发环境用style-loader注入到DOM
          process.env.NODE_ENV === 'production'
            ? MiniCssExtractPlugin.loader
            : 'style-loader',
          {
            loader: 'css-loader', // 解析CSS文件中的@import和url()
            options: {
              importLoaders: 2, // 导入的CSS文件也会经过后续2个loader（postcss-loader + 预处理器）
              sourceMap: process.env.NODE_ENV !== 'production' // 开发环境生成sourceMap，便于调试
            }
          },
          {
            loader: 'postcss-loader', // Vue CLI 必选：自动添加浏览器前缀、CSS变量转换等
            options: {
              postcssOptions: {
                plugins: [
                  require('autoprefixer')({ // 自动添加浏览器前缀（配合browserslist）
                    overrideBrowserslist: ['> 1%', 'last 2 versions', 'not dead']
                  }),
                  require('postcss-preset-env')({ // 支持现代CSS特性
                    stage: 3
                  }),
                  process.env.NODE_ENV === 'production' && require('cssnano')({ // 生产环境压缩CSS
                    preset: 'default'
                  })
                ].filter(Boolean)
              },
              sourceMap: process.env.NODE_ENV !== 'production'
            }
          },
          // 预处理器loader：根据文件后缀自动匹配（Vue CLI 支持所有主流预处理器）
          {
            loader: 'sass-loader', // 处理SCSS/SASS（需安装sass/sass-loader）
            options: {
              sourceMap: process.env.NODE_ENV !== 'production'
            }
          },
          {
            loader: 'less-loader', // 处理LESS（需安装less/less-loader）
            options: {
              sourceMap: process.env.NODE_ENV !== 'production',
              lessOptions: {
                javascriptEnabled: true // 支持LESS中使用JS表达式
              }
            }
          },
          {
            loader: 'stylus-loader', // 处理Stylus（需安装stylus/stylus-loader）
            options: {
              sourceMap: process.env.NODE_ENV !== 'production'
            }
          }
        ],
        exclude: /node_modules/
      },

      // ===================== 静态资源处理（图片、字体、媒体等） =====================
      {
        test: /\.(png|jpe?g|gif|webp|avif)$/i, // 匹配图片文件
        type: 'asset', // Webpack5 内置Asset模块，自动选择inline或file
        parser: {
          dataUrlCondition: {
            maxSize: 4 * 1024 // 小于4KB的图片转为base64内联到代码（减少HTTP请求）
          }
        },
        generator: {
          filename: 'assets/images/[name].[hash:8][ext][query]' // 图片输出路径
        }
      },
      {
        test: /\.(svg)$/i, // SVG文件单独处理（支持Vue组件导入SVG）
        oneOf: [
          {
            resourceQuery: /vue/, // 匹配.vue文件中导入的SVG（如 <component :is="svgComponent" />）
            use: ['vue-loader', 'vue-svg-loader']
          },
          {
            type: 'asset',
            parser: {
              dataUrlCondition: {
                maxSize: 4 * 1024
              }
            },
            generator: {
              filename: 'assets/svg/[name].[hash:8][ext][query]'
            }
          }
        ]
      },
      {
        test: /\.(woff2?|eot|ttf|otf)$/i, // 匹配字体文件
        type: 'asset/resource', // 强制输出为文件（不内联）
        generator: {
          filename: 'assets/fonts/[name].[hash:8][ext][query]' // 字体输出路径
        }
      },
      {
        test: /\.(mp4|webm|ogg|mp3|wav|flac|aac)$/i, // 匹配媒体文件
        type: 'asset/resource',
        generator: {
          filename: 'assets/media/[name].[hash:8][ext][query]' // 媒体输出路径
        }
      },

      // ===================== 其他文件处理 =====================
      {
        test: /\.(json|xml|toml|yaml|yml)$/i, // 匹配配置文件
        type: 'asset/resource',
        generator: {
          filename: 'assets/configs/[name].[hash:8][ext][query]'
        }
      }
    ]
  },

  // 插件配置（Vue CLI 核心插件，实现各种增强功能）
  plugins: [
    // 1. Vue Loader 必备插件：编译.vue文件的模板和样式
    new VueLoaderPlugin(),

    // 2. 环境变量注入：将.env文件中的变量注入到代码中（如 process.env.VUE_APP_XXX）
    new DefinePlugin({
      'process.env': JSON.stringify(process.env),
      __VUE_OPTIONS_API__: JSON.stringify(true), // 启用Vue2选项式API（Vue3兼容用）
      __VUE_PROD_DEVTOOLS__: JSON.stringify(false), // 生产环境禁用Vue DevTools
      __VUE_PROD_HYDRATION_MISMATCH_DETAILS__: JSON.stringify(false) // 生产环境隐藏 hydration 错误详情
    }),

    // 3. 生成HTML文件：自动注入打包后的JS/CSS资源（Vue CLI 默认使用public/index.html作为模板）
    new HtmlWebpackPlugin({
      template: path.resolve(__dirname, 'public/index.html'), // 模板文件路径
      filename: 'index.html', // 输出文件名
      title: 'Vue CLI App', // 页面标题（可通过.env配置覆盖）
      favicon: path.resolve(__dirname, 'public/favicon.ico'), // 网站图标
      minify: process.env.NODE_ENV === 'production' ? {
        // 生产环境压缩HTML
        removeComments: true, // 移除注释
        collapseWhitespace: true, // 折叠空白
        removeAttributeQuotes: true // 移除属性引号
      } : false,
      hash: process.env.NODE_ENV === 'production', // 生产环境给资源添加hash，避免缓存
      inject: 'body' // 资源注入到body末尾（优化首屏加载）
    }),

    // 4. 复制静态资源：将public目录下的文件复制到dist（除了index.html）
    new CopyPlugin({
      patterns: [
        {
          from: path.resolve(__dirname, 'public'),
          to: path.resolve(__dirname, 'dist'),
          globOptions: {
            ignore: ['**/index.html', '**/.DS_Store', '**/node_modules/**'] // 忽略index.html（由HtmlWebpackPlugin生成）
          }
        }
      ]
    }),

    // 5. ESLint 校验：构建时自动校验JS/Vue文件（Vue CLI 默认开启）
    new ESLintPlugin({
      context: path.resolve(__dirname, 'src'), // 校验目录
      extensions: ['js', 'jsx', 'vue', 'ts', 'tsx'], // 校验文件类型
      fix: true, // 自动修复可修复的ESLint错误
      cache: true, // 缓存校验结果，提升构建速度
      cacheLocation: path.resolve(__dirname, 'node_modules/.cache/eslint-loader')
    }),

    // 6. StyleLint 校验：构建时自动校验CSS/SCSS等样式文件
    new StylelintPlugin({
      files: ['src/**/*.{vue,css,scss,sass,less,styl,stylus}'], // 校验文件
      fix: true, // 自动修复可修复的StyleLint错误
      cache: true,
      cacheLocation: path.resolve(__dirname, 'node_modules/.cache/stylelint-loader')
    }),

    // 7. 自动导入API：如Vue的ref、reactive，Element Plus的组件（无需手动import）
    AutoImport({
      resolvers: [ElementPlusResolver()], // 自动导入Element Plus的API
      imports: ['vue', 'vue-router', 'pinia'], // 自动导入Vue核心API
      dts: path.resolve(__dirname, 'src/auto-imports.d.ts') // 生成类型声明文件
    }),

    // 8. 自动注册组件：无需手动注册全局组件（如Element Plus组件、自定义组件）
    Components({
      resolvers: [ElementPlusResolver()], // 自动注册Element Plus组件
      dirs: ['src/components'], // 扫描自定义组件目录
      extensions: ['vue', 'tsx'], // 组件文件类型
      dts: path.resolve(__dirname, 'src/components.d.ts') // 生成类型声明文件
    }),

    // 9. 生成资源清单：记录文件名与hash的映射（用于CDN部署或缓存控制）
    new WebpackManifestPlugin({
      fileName: 'asset-manifest.json',
      publicPath: process.env.VUE_APP_PUBLIC_PATH || '/',
      generate: (seed, files) => {
        const manifestFiles = files.reduce((manifest, file) => {
          manifest[file.name] = file.path;
          return manifest;
        }, seed);
        return { files: manifestFiles };
      }
    }),

    // 10. TypeScript 类型检查：单独开启进程进行TS类型检查（不阻塞构建）
    new ForkTsCheckerWebpackPlugin({
      typescript: {
        configFile: path.resolve(__dirname, 'tsconfig.json'),
        diagnosticOptions: {
          semantic: true,
          syntactic: true
        }
      },
      async: process.env.NODE_ENV !== 'production' // 开发环境异步检查（不阻塞构建）
    }),

    // 11. 生产环境：CSS Tree Shaking（移除未使用的CSS）
    process.env.NODE_ENV === 'production' && new PurgeCSSPlugin({
      paths: glob.sync([
        path.resolve(__dirname, 'src/**/*.vue'),
        path.resolve(__dirname, 'src/**/*.js'),
        path.resolve(__dirname, 'public/index.html')
      ]), // 扫描所有使用CSS的文件
      extractors: [
        {
          extractor: content => content.match(/[\w-/:]+(?<!:)/g) || [],
          extensions: ['vue', 'js', 'html']
        }
      ],
      safelist: ['html', 'body'] // 保留必要的基础样式
    })
  ].filter(Boolean), // 过滤掉false的插件（如生产环境才启用的插件）
};

// ===================== 开发环境配置（覆盖基础配置） =====================
if (process.env.NODE_ENV === 'development') {
  module.exports = {
    ...baseConfig,
    // 模式：开发环境（webpack会启用开发环境优化，如不压缩代码）
    mode: 'development',
    // 开发工具：生成sourceMap（便于调试，Vue CLI 默认eval-cheap-module-source-map）
    devtool: 'eval-cheap-module-source-map',
    // 开发服务器（Vue CLI 的 devServer 配置，对应 vue.config.js 的 devServer）
    devServer: {
      host: '0.0.0.0', // 允许外部访问
      port: 8080, // 端口号
      open: true, // 启动后自动打开浏览器
      hot: true, // 启用热模块替换（HMR，无需刷新页面更新）
      client: {
        overlay: true, // 构建错误显示在浏览器页面上
        progress: true, // 浏览器显示构建进度
      },
      compress: true, // 启用Gzip压缩
      historyApiFallback: true, // 支持SPA路由（Vue Router的history模式）
      proxy: {
        // 接口代理（解决跨域问题，Vue CLI 常用配置）
        '/api': {
          target: process.env.VUE_APP_API_BASE_URL || 'http://localhost:3000',
          changeOrigin: true, // 跨域时修改Origin
          pathRewrite: { '^/api': '' } // 重写路径（去掉/api前缀）
        }
      },
      static: {
        directory: path.resolve(__dirname, 'public'), // 静态资源目录
        watch: true // 监听静态资源变化，自动刷新
      }
    },
    // 优化配置（开发环境）
    optimization: {
      runtimeChunk: 'single', // 提取运行时代码（避免频繁变动）
      splitChunks: {
        chunks: 'all', // 分割所有类型的Chunk（同步+异步）
        cacheGroups: {
          vendor: {
            // 提取第三方依赖（如vue、element-plus）到vendor chunk
            test: /[\\/]node_modules[\\/]/,
            name: 'vendors',
            priority: -10 // 优先级高于默认缓存组
          },
          common: {
            // 提取公共模块（被多次引用的模块）
            minChunks: 2, // 最小引用次数
            priority: -20,
            reuseExistingChunk: true // 复用已存在的Chunk
          }
        }
      }
    }
  };
}

// ===================== 生产环境配置（覆盖基础配置） =====================
if (process.env.NODE_ENV === 'production') {
  module.exports = {
    ...baseConfig,
    // 模式：生产环境（webpack会启用生产环境优化，如压缩代码、Tree Shaking）
    mode: 'production',
    // 开发工具：生产环境生成sourceMap（便于线上调试，可通过productionSourceMap关闭）
    devtool: process.env.VUE_APP_PRODUCTION_SOURCE_MAP === 'true' 
      ? 'source-map' 
      : false,
    // 优化配置（生产环境核心优化）
    optimization: {
      // 代码分割：提取公共依赖和运行时
      splitChunks: {
        chunks: 'all',
        minSize: 20000, // 最小Chunk大小（20KB）
        minRemainingSize: 0,
        minChunks: 1, // 最小引用次数
        maxAsyncRequests: 30, // 异步请求最大数量
        maxInitialRequests: 30, // 初始请求最大数量
        enforceSizeThreshold: 50000, // 强制分割阈值
        cacheGroups: {
          vendor: {
            test: /[\\/]node_modules[\\/]/,
            name: 'vendors',
            priority: -10,
            reuseExistingChunk: true,
            chunks: 'all'
          },
          common: {
            name: 'common',
            minChunks: 2,
            priority: -20,
            reuseExistingChunk: true
          },
          styles: {
            // 提取所有CSS到单独的Chunk
            name: 'styles',
            test: /\.(css|scss|sass|less|styl)$/,
            chunks: 'all',
            enforce: true
          }
        }
      },
      runtimeChunk: {
        name: entrypoint => `runtime-${entrypoint.name}` // 为每个入口生成独立的运行时Chunk
      },
      // 最小化配置（压缩JS/CSS）
      minimizer: [
        // 压缩JS（Vue CLI 默认使用terser，替代uglifyjs）
        new TerserPlugin({
          terserOptions: {
            compress: {
              drop_console: process.env.VUE_APP_DROP_CONSOLE === 'true', // 可选：移除console
              drop_debugger: true, // 移除debugger
              pure_funcs: ['console.log'] // 仅移除console.log（保留其他console方法）
            },
            mangle: {
              safari10: true // 兼容Safari 10+
            },
            output: {
              ascii_only: true, // 仅输出ASCII字符，避免中文乱码
              comments: false // 移除注释
            }
          },
          parallel: true, // 并行压缩（提升速度）
          extractComments: false // 不提取注释到单独文件
        }),
        // 压缩CSS（生产环境默认启用）
        new CssMinimizerPlugin({
          minimizerOptions: {
            preset: [
              'default',
              {
                discardComments: { removeAll: true } // 移除所有CSS注释
              }
            ]
          },
          parallel: true
        })
      ],
      // 模块标识符：使用hash替代路径，提升缓存命中率
      moduleIds: 'deterministic',
      // Chunk标识符：使用hash替代索引，提升缓存命中率
      chunkIds: 'deterministic'
    },
    // 生产环境插件补充
    plugins: [
      ...baseConfig.plugins,
      // 提取CSS到单独文件（生产环境启用，替代style-loader）
      new MiniCssExtractPlugin({
        filename: 'css/[name].[contenthash:8].css', // CSS输出名（加contenthash做缓存）
        chunkFilename: 'css/[name].[contenthash:8].chunk.css', // 异步Chunk的CSS
        ignoreOrder: true // 忽略CSS顺序警告
      })
    ],
    // 性能提示（生产环境）
    performance: {
      hints: 'warning', // 体积超过阈值时给出警告
      maxEntrypointSize: 500 * 1024, // 入口Chunk最大体积（500KB）
      maxAssetSize: 250 * 1024, // 单个资源最大体积（250KB）
      assetFilter: assetFilename => {
        // 仅对JS/CSS文件进行体积检查（忽略图片、字体等）
        return assetFilename.endsWith('.js') || assetFilename.endsWith('.css');
      }
    }
  };
}
```